import pyaudio  # type: ignore
import grpc  # type: ignore
import os
import subprocess
import wave
import tempfile
from datetime import datetime
from typing import Generator
from yandex.cloud.ai.stt.v3 import stt_pb2  # type: ignore
from yandex.cloud.ai.stt.v3 import stt_service_pb2_grpc  # type: ignore

class StreamRecognizer:
    def __init__(self):
        self.FORMAT = pyaudio.paInt16
        self.CHANNELS = 1
        self.RATE = 8000
        self.CHUNK = 4096
        self.audio = pyaudio.PyAudio()
        self.api_key = os.getenv('YANDEX_API_KEY')
        self.stream = None
        self.is_initialized = False
        self.previous_text = ""
        self.should_stop = False
        self.is_first_phrase = True
        self.debug = os.getenv("JORA_DEBUG") == "1"

        # –ë—É—Ñ–µ—Ä –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω—ã—Ö —á–∞–Ω–∫–æ–≤
        self.initial_buffer = []
        self.BUFFER_SIZE = 5  # –°–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –±—É—Ñ–µ—Ä–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π

    def _debug_save_and_play(self, audio_data: bytes):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏"""
        try:
            # –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π WAV —Ñ–∞–π–ª
            temp_wav = tempfile.NamedTemporaryFile(suffix=".wav", delete=False)
            with wave.open(temp_wav.name, 'wb') as wf:
                wf.setnchannels(self.CHANNELS)
                wf.setsampwidth(self.audio.get_sample_size(self.FORMAT))
                wf.setframerate(self.RATE)
                wf.writeframes(audio_data)

            # –ö–æ–ø–∏—Ä—É–µ–º –≤ debug_records
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            debug_file = f"debug_records/stream_{timestamp}.wav"
            subprocess.run(['cp', temp_wav.name, debug_file], check=True)
            print(f"üîç –°–æ—Ö—Ä–∞–Ω–∏–ª —Å—Ç—Ä–∏–º: {debug_file}")

            # –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
            subprocess.run(['play', '-q', temp_wav.name], check=True)

            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–µ–±–∞–≥ –∑–∞–ø–∏—Å—å
            os.unlink(temp_wav.name)
            os.unlink(debug_file)

        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ª–∞–¥–∫–∏: {e}")

    def get_streaming_options(self) -> stt_pb2.StreamingOptions:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è"""
        return stt_pb2.StreamingOptions(
            recognition_model=stt_pb2.RecognitionModelOptions(
                audio_format=stt_pb2.AudioFormatOptions(
                    raw_audio=stt_pb2.RawAudio(
                        audio_encoding=stt_pb2.RawAudio.LINEAR16_PCM,
                        sample_rate_hertz=8000,
                        audio_channel_count=1
                    )
                ),
                text_normalization=stt_pb2.TextNormalizationOptions(
                    text_normalization=stt_pb2.TextNormalizationOptions.TEXT_NORMALIZATION_ENABLED,
                    profanity_filter=False,
                    literature_text=True
                ),
                language_restriction=stt_pb2.LanguageRestrictionOptions(
                    restriction_type=stt_pb2.LanguageRestrictionOptions.WHITELIST,
                    language_code=['ru-RU']
                ),
                audio_processing_type=stt_pb2.RecognitionModelOptions.REAL_TIME
            ),
            eou_classifier=stt_pb2.EouClassifierOptions(
                default_classifier=stt_pb2.DefaultEouClassifier(
                    type=stt_pb2.DefaultEouClassifier.HIGH,
                    max_pause_between_words_hint_ms=1000
                )
            )
        )

    def initialize_stream(self) -> bool:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞"""
        try:
            if self.stream is None:
                print("üéôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –ø–æ—Ç–æ–∫...")
                self.stream = self.audio.open(
                    format=self.FORMAT,
                    channels=self.CHANNELS,
                    rate=self.RATE,
                    input=True,
                    frames_per_buffer=self.CHUNK
                )
                self.stream.start_stream()
                self.is_initialized = True
                print("üéôÔ∏è –ü–æ—Ç–æ–∫ –≥–æ—Ç–æ–≤!")
            return True
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞: {e}")
            self.is_initialized = False
            return False

    def emulate_typing(self, text: str):
        """–≠–º—É–ª–∏—Ä—É–µ—Ç –ø–µ—á–∞—Ç—å —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ wtype"""
        try:
            if not self.is_first_phrase:
                subprocess.run(['wtype', ' ' + text], check=True)
            else:
                subprocess.run(['wtype', text], check=True)
                self.is_first_phrase = False
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —ç–º—É–ª—è—Ü–∏–∏ –ø–µ—á–∞—Ç–∏: {e}")

    def audio_generator(self) -> Generator[stt_pb2.StreamingRequest, None, None]:
        """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö"""
        if not self.initialize_stream():
            print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫!")
            return

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        yield stt_pb2.StreamingRequest(session_options=self.get_streaming_options())

        try:
            # –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –±—É—Ñ–µ—Ä
            print("üéôÔ∏è –ù–∞–∫–∞–ø–ª–∏–≤–∞—é –±—É—Ñ–µ—Ä...")
            self.initial_buffer = []
            all_data = bytes()  # –î–ª—è –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º–∞

            for _ in range(self.BUFFER_SIZE):
                if self.stream:
                    data = self.stream.read(self.CHUNK, exception_on_overflow=False)
                    self.initial_buffer.append(data)
                    if self.debug:
                        all_data += data

            # –í —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä
            if self.debug and all_data:
                self._debug_save_and_play(all_data)

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –±—É—Ñ–µ—Ä
            for data in self.initial_buffer:
                yield stt_pb2.StreamingRequest(chunk=stt_pb2.AudioChunk(data=data))

            # –¢–µ–ø–µ—Ä—å —Å—Ç—Ä–∏–º–∏–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
            print("üéôÔ∏è –°–ª—É—à–∞—é —Ç–µ–±—è, –±—Ä–∞—Ç–∏—à–∫–∞...")
            debug_buffer = bytes()  # –ë—É—Ñ–µ—Ä –¥–ª—è –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º–∞

            while not self.should_stop:
                if self.stream:
                    data = self.stream.read(self.CHUNK, exception_on_overflow=False)
                    if self.debug:
                        debug_buffer += data
                        # –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤ –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º–µ
                        if len(debug_buffer) >= self.RATE * 2:
                            self._debug_save_and_play(debug_buffer)
                            debug_buffer = bytes()
                    yield stt_pb2.StreamingRequest(chunk=stt_pb2.AudioChunk(data=data))

        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ—Ç–æ–∫–∞: {e}")
        finally:
            self.cleanup()

    def recognize_stream(self) -> None:
        self.should_stop = False
        cred = grpc.ssl_channel_credentials()
        channel = grpc.secure_channel('stt.api.cloud.yandex.net:443', cred)
        stub = stt_service_pb2_grpc.RecognizerStub(channel)

        responses = stub.RecognizeStreaming(
            self.audio_generator(),
            metadata=[('authorization', f'Api-Key {self.api_key}')]
        )

        current_text = ""
        partial_text = ""

        try:
            for response in responses:
                if self.should_stop:
                    break

                event_type = response.WhichOneof('Event')

                if event_type == 'partial':
                    if len(response.partial.alternatives) > 0:
                        partial_text = response.partial.alternatives[0].text
                        print(f"\rüéØ {partial_text:<60}", end='', flush=True)

                elif event_type == 'final_refinement':
                    if len(response.final_refinement.normalized_text.alternatives) > 0:
                        text = response.final_refinement.normalized_text.alternatives[0].text

                        if text.strip().lower() == "–∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–ø–∏—Å—å.":
                            print("\n‚úÖ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∞!")
                            self.stop()
                            return

                        if text and text != current_text:
                            print("\r" + " " * (len(partial_text) + 60), end='\r')
                            self.emulate_typing(text)
                            current_text = text
                            print(f"\rüìù {text}")

        except Exception as e:
            print(f"\n‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}")
        finally:
            self.cleanup()
            channel.close()
            self.is_first_phrase = True

    def stop(self):
        """–ú–µ—Ç–æ–¥ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"""
        if self.stream:
            try:
                self.should_stop = True
                import time
                time.sleep(0.1)
                self.cleanup()
                self.is_first_phrase = True
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ: {e}")

    def cleanup(self):
        """–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Ç–æ–∫–∞"""
        if self.stream:
            try:
                self.stream.stop_stream()
                self.stream.close()
                self.stream = None
                import time
                time.sleep(0.1)
            except Exception as e:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–æ—Ç–æ–∫–∞: {e}")
            finally:
                self.is_initialized = False

    def __del__(self):
        """–û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞"""
        self.cleanup()
        if self.audio:
            self.audio.terminate()
